mysql> CREATE DATABASE Library;
Query OK, 1 row affected (0.01 sec)

mysql> USE Library;
Database changed
mysql> CREATE TABLE Borrower (
         Roll_no INT(3),
         Name VARCHAR(30),
        Date_of_Issue DATE,
         Name_of_Book VARCHAR(30),
         Status CHAR(1)
     );
Query OK, 0 rows affected, 1 warning (0.03 sec)

mysql> CREATE TABLE Fine (
         Roll_no INT(3),
         Date DATE,
         Amt INT
     );
Query OK, 0 rows affected, 1 warning (0.03 sec)

mysql> INSERT INTO Borrower VALUES
     (1, 'Srushti', '2024-10-01', 'DBMS', 'I'),
     (2, 'Lily', '2024-10-15', 'AI', 'I'),
    (3, 'Rahul', '2024-09-20', 'DBMS', 'I');
Query OK, 3 rows affected (0.01 sec)
Records: 3  Duplicates: 0  Warnings: 0

mysql> SELECT * FROM Borrower;
+---------+---------+---------------+--------------+--------+
| Roll_no | Name    | Date_of_Issue | Name_of_Book | Status |
+---------+---------+---------------+--------------+--------+
|       1 | Srushti | 2024-10-01    | DBMS         | I      |
|       2 | Lily    | 2024-10-15    | AI           | I      |
|       3 | Rahul   | 2024-09-20    | DBMS         | I      |
+---------+---------+---------------+--------------+--------+
3 rows in set (0.00 sec)

mysql> DELIMITER $
mysql> CREATE PROCEDURE fine_calculation(IN rno INT(3), IN bname VARCHAR(30))
     BEGIN
         DECLARE i_date DATE;
         DECLARE diff INT;
         DECLARE fine_amt INT DEFAULT 0;
    
         -- Exception handler for table or data not found
         DECLARE EXIT HANDLER FOR SQLEXCEPTION
         BEGIN
             SELECT 'Error: Table not found or invalid data!' AS Message;
         END;
    
         -- Get date of issue for given roll number and book
         SELECT Date_of_Issue INTO i_date
        FROM Borrower
         WHERE Roll_no = rno AND Name_of_Book = bname;
   
         -- Calculate number of days
         SELECT DATEDIFF(CURDATE(), i_date) INTO diff;
    
         -- Apply fine rules
        IF (diff > 15 AND diff <= 30) THEN
             SET fine_amt = diff * 5;
             INSERT INTO Fine VALUES (rno, CURDATE(), fine_amt);
         ELSEIF (diff > 30) THEN
             SET fine_amt = (15 * 5) + ((diff - 30) * 50);
             INSERT INTO Fine VALUES (rno, CURDATE(), fine_amt);
         ELSE
             SET fine_amt = 0;  -- No fine
         END IF;
    
         -- Update book status from 'I' (Issued) to 'R' (Returned)
         UPDATE Borrower
         SET Status = 'R'
         WHERE Roll_no = rno AND Name_of_Book = bname;
    
        -- Display result
         SELECT CONCAT('Fine for Roll No ', rno, ' is Rs. ', fine_amt) AS Result;
     END;
     $
Query OK, 0 rows affected, 1 warning (0.01 sec)

mysql>
mysql> DELIMITER ;
mysql> CALL fine_calculation(3, 'DBMS');
+---------------------------------+
| Result                          |
+---------------------------------+
| Fine for Roll No 3 is Rs. 19075 |
+---------------------------------+
1 row in set (0.02 sec)

Query OK, 0 rows affected (0.04 sec)

mysql> SELECT * FROM Fine;
+---------+------------+-------+
| Roll_no | Date       | Amt   |
+---------+------------+-------+
|       3 | 2025-11-04 | 19075 |
+---------+------------+-------+
1 row in set (0.00 sec)

mysql> SELECT * FROM Borrower;
+---------+---------+---------------+--------------+--------+
| Roll_no | Name    | Date_of_Issue | Name_of_Book | Status |
+---------+---------+---------------+--------------+--------+
|       1 | Srushti | 2024-10-01    | DBMS         | I      |
|       2 | Lily    | 2024-10-15    | AI           | I      |
|       3 | Rahul   | 2024-09-20    | DBMS         | R      |
+---------+---------+---------------+--------------+--------+
3 rows in set (0.00 sec)
